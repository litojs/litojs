// @bun
import{promises as Bt}from"fs";import it from"path";function ft(){const t=new Map;for(let[x,n]of Object.entries($)){for(let[H,R]of Object.entries(n))$[H]={open:`\x1B[${R[0]}m`,close:`\x1B[${R[1]}m`},n[H]=$[H],t.set(R[0],R[1]);Object.defineProperty($,x,{value:n,enumerable:!1})}return Object.defineProperty($,"codes",{value:t,enumerable:!1}),$.color.close="\x1B[39m",$.bgColor.close="\x1B[49m",$.color.ansi=N(),$.color.ansi256=Y(),$.color.ansi16m=A(),$.bgColor.ansi=N(10),$.bgColor.ansi256=Y(10),$.bgColor.ansi16m=A(10),Object.defineProperties($,{rgbToAnsi256:{value(x,n,H){if(x===n&&n===H){if(x<8)return 16;if(x>248)return 231;return Math.round((x-8)/247*24)+232}return 16+36*Math.round(x/255*5)+6*Math.round(n/255*5)+Math.round(H/255*5)},enumerable:!1},hexToRgb:{value(x){const n=/[a-f\d]{6}|[a-f\d]{3}/i.exec(x.toString(16));if(!n)return[0,0,0];let[H]=n;if(H.length===3)H=[...H].map((r)=>r+r).join("");const R=Number.parseInt(H,16);return[R>>16&255,R>>8&255,R&255]},enumerable:!1},hexToAnsi256:{value:(x)=>$.rgbToAnsi256(...$.hexToRgb(x)),enumerable:!1},ansi256ToAnsi:{value(x){if(x<8)return 30+x;if(x<16)return 90+(x-8);let n,H,R;if(x>=232)n=((x-232)*10+8)/255,H=n,R=n;else{x-=16;const D=x%36;n=Math.floor(x/36)/5,H=Math.floor(D/6)/5,R=D%6/5}const r=Math.max(n,H,R)*2;if(r===0)return 30;let f=30+(Math.round(R)<<2|Math.round(H)<<1|Math.round(n));if(r===2)f+=60;return f},enumerable:!1},rgbToAnsi:{value:(x,n,H)=>$.ansi256ToAnsi($.rgbToAnsi256(x,n,H)),enumerable:!1},hexToAnsi:{value:(x)=>$.ansi256ToAnsi($.hexToAnsi256(x)),enumerable:!1}}),$}var N=(t=0)=>(x)=>`\x1B[${x+t}m`,Y=(t=0)=>(x)=>`\x1B[${38+t};5;${x}m`,A=(t=0)=>(x,n,H)=>`\x1B[${38+t};2;${x};${n};${H}m`,$={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],gray:[90,39],grey:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgGray:[100,49],bgGrey:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}},Kt=Object.keys($.modifier),Rt=Object.keys($.color),rt=Object.keys($.bgColor),Qt=[...Rt,...rt],$t=ft(),I=$t;import W from"process";import Ot from"os";import q from"tty";function w(t,x=globalThis.Deno?globalThis.Deno.args:W.argv){const n=t.startsWith("-")?"":t.length===1?"-":"--",H=x.indexOf(n+t),R=x.indexOf("--");return H!==-1&&(R===-1||H<R)}function ut(){if("FORCE_COLOR"in O){if(O.FORCE_COLOR==="true")return 1;if(O.FORCE_COLOR==="false")return 0;return O.FORCE_COLOR.length===0?1:Math.min(Number.parseInt(O.FORCE_COLOR,10),3)}}function Ct(t){if(t===0)return!1;return{level:t,hasBasic:!0,has256:t>=2,has16m:t>=3}}function wt(t,{streamIsTTY:x,sniffFlags:n=!0}={}){const H=ut();if(H!==void 0)K=H;const R=n?K:H;if(R===0)return 0;if(n){if(w("color=16m")||w("color=full")||w("color=truecolor"))return 3;if(w("color=256"))return 2}if("TF_BUILD"in O&&"AGENT_NAME"in O)return 1;if(t&&!x&&R===void 0)return 0;const r=R||0;if(O.TERM==="dumb")return r;if(W.platform==="win32"){const f=Ot.release().split(".");if(Number(f[0])>=10&&Number(f[2])>=10586)return Number(f[2])>=14931?3:2;return 1}if("CI"in O){if("GITHUB_ACTIONS"in O||"GITEA_ACTIONS"in O)return 3;if(["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","BUILDKITE","DRONE"].some((f)=>(f in O))||O.CI_NAME==="codeship")return 1;return r}if("TEAMCITY_VERSION"in O)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(O.TEAMCITY_VERSION)?1:0;if(O.COLORTERM==="truecolor")return 3;if(O.TERM==="xterm-kitty")return 3;if("TERM_PROGRAM"in O){const f=Number.parseInt((O.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(O.TERM_PROGRAM){case"iTerm.app":return f>=3?3:2;case"Apple_Terminal":return 2}}if(/-256(color)?$/i.test(O.TERM))return 2;if(/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(O.TERM))return 1;if("COLORTERM"in O)return 1;return r}function b(t,x={}){const n=wt(t,{streamIsTTY:t&&t.isTTY,...x});return Ct(n)}var{env:O}=W,K;if(w("no-color")||w("no-colors")||w("color=false")||w("color=never"))K=0;else if(w("color")||w("colors")||w("color=true")||w("color=always"))K=1;var Mt={stdout:b({isTTY:q.isatty(1)}),stderr:b({isTTY:q.isatty(2)})},c=Mt;function m(t,x,n){let H=t.indexOf(x);if(H===-1)return t;const R=x.length;let r=0,f="";do f+=t.slice(r,H)+x+n,r=H+R,H=t.indexOf(x,r);while(H!==-1);return f+=t.slice(r),f}function S(t,x,n,H){let R=0,r="";do{const f=t[H-1]==="\r";r+=t.slice(R,f?H-1:H)+x+(f?"\r\n":"\n")+n,R=H+1,H=t.indexOf("\n",R)}while(H!==-1);return r+=t.slice(R),r}function J(t){return It(t)}var{stdout:d,stderr:F}=c,X=Symbol("GENERATOR"),B=Symbol("STYLER"),E=Symbol("IS_EMPTY"),_=["ansi","ansi","ansi256","ansi16m"],i=Object.create(null),Dt=(t,x={})=>{if(x.level&&!(Number.isInteger(x.level)&&x.level>=0&&x.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");const n=d?d.level:0;t.level=x.level===void 0?n:x.level};var It=(t)=>{const x=(...n)=>n.join(" ");return Dt(x,t),Object.setPrototypeOf(x,J.prototype),x};Object.setPrototypeOf(J.prototype,Function.prototype);for(let[t,x]of Object.entries(I))i[t]={get(){const n=Q(this,G(x.open,x.close,this[B]),this[E]);return Object.defineProperty(this,t,{value:n}),n}};i.visible={get(){const t=Q(this,this[B],!0);return Object.defineProperty(this,"visible",{value:t}),t}};var Z=(t,x,n,...H)=>{if(t==="rgb"){if(x==="ansi16m")return I[n].ansi16m(...H);if(x==="ansi256")return I[n].ansi256(I.rgbToAnsi256(...H));return I[n].ansi(I.rgbToAnsi(...H))}if(t==="hex")return Z("rgb",x,n,...I.hexToRgb(...H));return I[n][t](...H)},Ut=["rgb","hex","ansi256"];for(let t of Ut){i[t]={get(){const{level:n}=this;return function(...H){const R=G(Z(t,_[n],"color",...H),I.color.close,this[B]);return Q(this,R,this[E])}}};const x="bg"+t[0].toUpperCase()+t.slice(1);i[x]={get(){const{level:n}=this;return function(...H){const R=G(Z(t,_[n],"bgColor",...H),I.bgColor.close,this[B]);return Q(this,R,this[E])}}}}var Tt=Object.defineProperties(()=>{},{...i,level:{enumerable:!0,get(){return this[X].level},set(t){this[X].level=t}}}),G=(t,x,n)=>{let H,R;if(n===void 0)H=t,R=x;else H=n.openAll+t,R=x+n.closeAll;return{open:t,close:x,openAll:H,closeAll:R,parent:n}},Q=(t,x,n)=>{const H=(...R)=>Pt(H,R.length===1?""+R[0]:R.join(" "));return Object.setPrototypeOf(H,Tt),H[X]=t,H[B]=x,H[E]=n,H},Pt=(t,x)=>{if(t.level<=0||!x)return t[E]?"":x;let n=t[B];if(n===void 0)return x;const{openAll:H,closeAll:R}=n;if(x.includes("\x1B"))while(n!==void 0)x=m(x,n.close,n.open),n=n.parent;const r=x.indexOf("\n");if(r!==-1)x=S(x,R,H,r);return H+x+R};Object.defineProperties(J.prototype,i);var zt=J(),Yt=J({level:F?F.level:0});var U=zt;class M{static log(t,x){console.log(t,x??"")}static info(t,x){console.log(U.blue(t),x)}static warn(t,x){console.log(U.yellow(t),x??"")}static success(t,x){console.log(U.green(t),x??"")}static error(t,x){console.log(U.red(t),x??"")}}async function k(t){try{const x=it.join(process.cwd(),"apps",t,"router.ts");try{await Bt.access(x)}catch{M.warn("You are registering an app that does not have router.ts");return}const n=await import(x);for(let H in n)if(n[H]?.getRoutes())return n[H].getRoutes()}catch(x){M.error(`Error importing app ${t}`,x)}}function g(t){const x=[],n=/^\/:[^/]+$/;for(let H=0;H<t.length;H++){const R=t[H];if(n.test(R.path))for(let r=0;r<t.length;r++){if(H===r)continue;const f=t[r];if(new RegExp(`^${R.path.replace(/:[^/]+/,"[^/]+")}\$`).test(f.path)){x.push(R.path);break}}}return x}function p(t){if(t.length>0)return`Conflicting routes found: ${t.join(", ")}. Consider using a prefix to avoid conflicts.`;return""}function v(t){const x={};return t.split(";").forEach((n)=>{const H=n.split(";").map((u)=>u.trim()),[R,...r]=H,[f,D]=R.split("=").map((u)=>u.trim());if(f){const u={name:decodeURIComponent(f),value:decodeURIComponent(D||""),httpOnly:!1,secure:!1};r.forEach((T)=>{const[z,C]=T.split("=").map((P)=>P.trim().toLowerCase());switch(z){case"httponly":u.httpOnly=!0;break;case"secure":u.secure=!0;break;case"path":u.path=C;break;case"domain":u.domain=C;break;case"expires":u.expires=new Date(C);break;case"samesite":u.sameSite=C;break}}),x[u.name]=u}}),x}function y(t,x){const n=new RegExp(`^${t}/?\$`);return x.match(n)}function o(t){return t.replace(/:\w+/g,(x)=>{return`(?<${x.substring(1)}>[^/]+)`})}function a(t,x,n){for(let H of n){const R=o(H.path),r=y(R,t);if(r&&H.method===x){const f=r.groups;return{route:H,params:f}}}return{}}function j(t,x,n={}){let H=`${encodeURIComponent(t)}=${encodeURIComponent(x)}`;if(n.maxAge!==void 0)H+=`; Max-Age=${n.maxAge}`;if(n.domain)H+=`; Domain=${n.domain}`;if(n.path)H+=`; Path=${n.path}`;if(n.expires)H+=`; Expires=${n.expires.toUTCString()}`;if(n.secure)H+="; Secure";if(n.httpOnly)H+="; HttpOnly";if(n.sameSite)H+=`; SameSite=${n.sameSite}`;return H}function l(t,x){const{pathname:n,searchParams:H}=new URL(t.url),{method:R}=t,{route:r,params:f}=a(n,R,x),D={};H.forEach((C,P)=>{D[P]=C});const u=v(t.headers.get("cookie")||""),T=[],z={user:null,params:{},headers:t.headers,url:t.url,path:n,status:200,query:D,cookies:u,cookie:{get:(C)=>u[C],set:(C,P,nt={})=>{const Ht=j(C,P,nt);T.push(Ht)},delete:(C)=>{const P=j(C,"",{maxAge:-1});T.push(P)}}};if(f)z.params=f;return{route:r,context:z,setCookies:T}}function Et(t,x){const n=t(x).toString();return new Response(n,{headers:{"content-type":"text/html; charset=UTF-8"}})}function s(t,x,n){const H=new Headers;if(t instanceof Response)t.headers.forEach((R,r)=>H.set(r,R));else if(typeof t==="object")H.set("Content-Type","application/json"),t=new Response(JSON.stringify(t),{status:x.status});else if(typeof t==="string"){if(t.trim().startsWith("<")&&t.trim().endsWith(">"))H.set("Content-Type","text/html");else H.set("Content-Type","text/plain");t=new Response(t,{status:x.status})}else t=new Response(String(t),{status:x.status});if(n.length>0)H.set("Set-Cookie",n.join(", "));return new Response(t.body,{status:x.status,headers:H})}function e(t,x,n){return{method:t,path:x,handler:n}}class V{lito;constructor(t){this.lito=t}handleResponse(t,x,n){return s(t,x,n)}async handleRequest(t){const{route:x,context:n,setCookies:H}=l(t,this.lito.routes),R=process.hrtime();if(x){let D;try{D=await x.handler(n)}catch(z){return new Response(z.message,{status:500})}const u=process.hrtime(R),T=(u[0]*1e9+u[1])/1e6;return M.log(`INFO: [${t.method}]:[${n.status}] ${n.path} - Time: ${T.toFixed(3)}ms`),this.handleResponse(D,n,H)}const r=process.hrtime(R),f=(r[0]*1e9+r[1])/1e6;return M.warn(`WARN: [${t.method}]:[404] ${n.path} - Time: ${f.toFixed(3)}ms`),new Response("Route not found",{status:404})}addRoute(t,x,n){return this.lito.routes.push(e(t,x,n)),this}}class L{_routes;_configuration;_handler;constructor(t){this._routes=[],this._configuration=t,this._handler=new V(this)}get routes(){return this._routes}get config(){return this._configuration}_createRoute(t,x,n){return this._handler.addRoute(t,x,n)}use(t){return this._routes.push(...t),this}get(t,x){return this._createRoute("GET",t,x)}post(t,x){return this._createRoute("POST",t,x)}put(t,x){return this._createRoute("PUT",t,x)}patch(t,x){return this._createRoute("PATCH",t,x)}delete(t,x){return this._createRoute("DELETE",t,x)}listen(t,x){if(x)x();Bun.serve({port:t,fetch:(n)=>this._handler.handleRequest(n)})}}async function Jt(t){const x=Number(process.env.PORT)||8000,n=[];for(let r of t.apps){const f=await k(r);if(f)n.push(...f)}const H=g(n),R=p(H);if(R)M.warn(R);return new L(t).use(n).listen(x,()=>{M.success(`Server running on port: ${x}`)})}class tt{}class h{router;controllerInstance;constructor(t){this.router=t}handle(t){return this.controllerInstance=new t,this}getMethod(t){const x=this.controllerInstance[t];if(typeof x!=="function")M.error(`Method "${U.underline(U.italic(String(t)))}" does not exist on controller ${U.underline(U.italic(String(this.controllerInstance.constructor.name)))}`);return x}get(t,x){const n=this.getMethod(x);return this.router.get(t,(H)=>n.call(this.controllerInstance,H)),this}post(t,x){const n=this.getMethod(x);return this.router.post(t,(H)=>n.call(this.controllerInstance,H)),this}put(t,x){const n=this.getMethod(x);return this.router.put(t,(H)=>n.call(this.controllerInstance,H)),this}patch(t,x){const n=this.getMethod(x);return this.router.patch(t,(H)=>n.call(this.controllerInstance,H)),this}delete(t,x){const n=this.getMethod(x);return this.router.delete(t,(H)=>n.call(this.controllerInstance,H)),this}}class xt{routes=[];controllerHandler;prefix;constructor(t){if(this.controllerHandler=new h(this),t!==void 0&&t.prefix!==void 0)this.prefix=t.prefix;else this.prefix=""}createRoute(t){return(x,n)=>{this.routes.push({method:t,path:x,handler:n})}}get(t,x){return this.createRoute("GET")(t,x)}post(t,x){return this.createRoute("POST")(t,x)}put(t,x){return this.createRoute("PUT")(t,x)}patch(t,x){return this.createRoute("PATCH")(t,x)}delete(t,x){return this.createRoute("DELETE")(t,x)}controller(t){return this.controllerHandler.handle(t)}getRoutes(){return this.routes}}export{Et as view,xt as Router,tt as Controller,Jt as App};
